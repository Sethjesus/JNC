<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç²¾è‹±åœ‹éš›æ•™è‚²åœ˜ ç©ºæ°£å“è³ªèˆ‡ ESG å„€è¡¨æ¿</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background-color: #111;
      color: #fff;
      padding: 1rem;
    }

    h1 {
      text-align: center;
      color: #90ee90;
      margin-bottom: 0.5rem;
    }

    .air-quality {
      display: flex;
      justify-content: center;
      gap: 2rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }

    .aq-box {
      background-color: #222;
      padding: 1rem 2rem;
      border-radius: 12px;
      text-align: center;
      min-width: 150px;
      box-shadow: 0 0 8px rgba(0, 255, 0, 0.1);
    }

    .aq-box .label {
      font-size: 1rem;
      color: #aaa;
    }

    .aq-box .value {
      font-size: 2rem;
      margin-top: 0.5rem;
    }

    .timestamp {
      text-align: center;
      font-size: 0.85rem;
      color: #aaa;
      margin-bottom: 1.5rem;
    }

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      max-width: 1000px;
      margin: auto;
    }

    .chart-box {
      background-color: #222;
      padding: 10px;
      border-radius: 12px;
      height: 250px;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.1);
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }

    .footer {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 0.9rem;
      color: #777;
    }

    .export-button {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }

    button {
      background-color: #00cc66;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
    }

    .total-carbon {
      text-align: center;
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #ccc;
    }
  </style>
</head>
<body>

  <h1>ğŸŒ¿ ç²¾è‹±åœ‹éš›æ•™è‚²åœ˜ ç©ºæ°£å“è³ªèˆ‡ ESG å„€è¡¨æ¿</h1>

  <div class="air-quality">
    <div class="aq-box">
      <div class="label">PM2.5 (Î¼g/mÂ³)</div>
      <div class="value" id="pm25">--</div>
    </div>
    <div class="aq-box">
      <div class="label">COâ‚‚ (ppm)</div>
      <div class="value" id="co2">--</div>
    </div>
  </div>
  <div class="timestamp" id="timestamp">æ›´æ–°æ™‚é–“ï¼š--</div>

  <div class="chart-grid">
    <div class="chart-box"><canvas id="electricityChart"></canvas></div>
    <div class="chart-box"><canvas id="waterChart"></canvas></div>
    <div class="chart-box"><canvas id="electricityCarbonChart"></canvas></div>
    <div class="chart-box"><canvas id="waterCarbonChart"></canvas></div>
  </div>

  <div class="total-carbon" id="totalCarbon">ç¸½ç¢³æ’æ”¾é‡ï¼š-- å…¬æ–¤</div>

  <div class="export-button">
    <button onclick="exportToExcel()">â¬‡ åŒ¯å‡ºç¢³æ’æ•¸æ“š Excel</button>
  </div>

  <div class="footer">è³‡æ–™æ¯æœˆæ›´æ–°ï¼šç©ºæ°£å“è³ªè‡ªå‹•ã€ç”¨æ°´é›»èˆ‡ç¢³æ’æ‰‹å‹•è¼¸å…¥</div>

  <script>
    // â›… è®€å–ç©ºæ°£å“è³ª data.json
    async function fetchAirQuality() {
      try {
        const res = await fetch("data.json", { cache: "no-store" });
        const data = await res.json();
        document.getElementById("pm25").textContent = data.pm25.toFixed(2);
        document.getElementById("co2").textContent = data.co2.toFixed(1);
        document.getElementById("timestamp").textContent = "æ›´æ–°æ™‚é–“ï¼š" + data.timestamp;
      } catch (e) {
        console.error("âŒ ç„¡æ³•è¼‰å…¥ç©ºæ°£å“è³ªè³‡æ–™", e);
      }
    }

    fetchAirQuality();
    setInterval(fetchAirQuality, 10000);

    // ğŸŒ± æ°´é›»ç¢³æ’è³‡æ–™
    const electricityCarbonFactor = 0.495;
    const waterCarbonFactor = 0.156;

    const labels = [
      "2023/9", "2023/10", "2023/11", "2023/12",
      "2024/1", "2024/2", "2024/3", "2024/4",
      "2024/5", "2024/6", "2024/7", "2024/8",
      "2024/9", "2024/10", "2024/11", "2024/12",
      "2025/1", "2025/2", "2025/3"
    ];

    const electricityData = [53.2, 6.9, 3.4, 7.3, 6.2, 0.2, 6.6, 2.2, 6.9, 66.9, 32.1, 8.8, 0, 0, 0, 86.9, 0, 25.6, 13.9];
    const waterData = [0, 0, 0, 0, 0, 0, 0, 197.77, 286.66, 319.4, 324.19, 309.01, 510.23, 404.39, 446.58, 409.36, 286.03, 285.45, 365.35];

    const electricityCarbonData = electricityData.map(e => e * electricityCarbonFactor);
    const waterCarbonData = waterData.map(w => w * waterCarbonFactor);
    const totalCarbon = electricityCarbonData.reduce((a, b) => a + b, 0) + waterCarbonData.reduce((a, b) => a + b, 0);
    document.getElementById("totalCarbon").textContent = `ç¸½ç¢³æ’æ”¾é‡ï¼š${totalCarbon.toFixed(2)} å…¬æ–¤`;

    // ğŸŒ¿ å»ºåœ–å‡½å¼
    function createChart(id, label, data, color) {
      const ctx = document.getElementById(id).getContext("2d");
      new Chart(ctx, {
        type: "line",
        data: {
          labels: labels,
          datasets: [{
            label: label,
            data: data,
            borderColor: color,
            backgroundColor: color + "33",
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: "top" }
          },
          scales: {
            y: { beginAtZero: true },
            x: { ticks: { color: "#ccc" } }
          }
        }
      });
    }

    createChart("electricityChart", "ç”¨é›»é‡ (kWh)", electricityData, "rgba(75, 192, 192, 1)");
    createChart("waterChart", "ç”¨æ°´é‡ (åº¦)", waterData, "rgba(255, 99, 132, 1)");
    createChart("electricityCarbonChart", "ç”¨é›»ç¢³æ’æ”¾ (å…¬æ–¤)", electricityCarbonData, "rgba(75, 192, 192, 1)");
    createChart("waterCarbonChart", "æ°´ç¢³æ’æ”¾ (å…¬æ–¤)", waterCarbonData, "rgba(255, 99, 132, 1)");

    // åŒ¯å‡º Excel
    function exportToExcel() {
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet([
        ['æœˆä»½', 'ç”¨é›»é‡ (kWh)', 'ç”¨æ°´é‡ (åº¦)', 'é›»ç¢³æ’ (kg)', 'æ°´ç¢³æ’ (kg)'],
        ...labels.map((l, i) => [
          l,
          electricityData[i] || '',
          waterData[i] || '',
          electricityCarbonData[i]?.toFixed(2) || '',
          waterCarbonData[i]?.toFixed(2) || ''
        ])
      ]);
      XLSX.utils.book_append_sheet(wb, ws, "ç¢³æ’è³‡æ–™");
      XLSX.writeFile(wb, "ç¢³æ’æ”¾çµ±è¨ˆ.xlsx");
    }
  </script>
</body>
</html>
